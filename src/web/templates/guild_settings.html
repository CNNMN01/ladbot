{% extends "base.html" %}

{% block title %}{{ guild.name }} Settings - Ladbot{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-server me-2"></i>{{ guild.name }} Settings
        </h1>
        <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Database Status Indicator -->
    <div class="alert alert-info" role="alert">
        <i class="fas fa-database me-2"></i>
        <strong>Database Integration Active:</strong> Settings are stored in PostgreSQL and sync immediately with the Discord bot.
    </div>

    <!-- Settings Form -->
    <form id="guildSettingsForm">

        <!-- Basic Server Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Server Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Server Name:</strong> {{ guild.name }}</p>
                        <p><strong>Server ID:</strong> {{ guild.id }}</p>
                        <p><strong>Member Count:</strong> {{ guild.member_count }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="prefix" class="form-label">Command Prefix</label>
                            <input type="text" class="form-control" name="prefix" id="prefix"
                                   value="{{ settings.get('prefix', 'l.') }}" maxlength="5">
                            <div class="form-text">The prefix used for bot commands (e.g., l.help)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Commands -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Admin Commands
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="settings" id="settings" {{ 'checked' if settings.get('settings', True) }}>
                            <label class="form-check-label" for="settings">
                                <strong>Settings Management</strong> - Configure bot settings
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="reload" id="reload" {{ 'checked' if settings.get('reload', True) }}>
                            <label class="form-check-label" for="reload">
                                <strong>Reload Cogs</strong> - Restart bot modules
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="logs" id="logs" {{ 'checked' if settings.get('logs', True) }}>
                            <label class="form-check-label" for="logs">
                                <strong>View Logs</strong> - Check bot logs
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="console" id="console" {{ 'checked' if settings.get('console', True) }}>
                            <label class="form-check-label" for="console">
                                <strong>Admin Console</strong> - Execute admin commands
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="autoresponse" id="autoresponse" {{ 'checked' if settings.get('autoresponse', True) }}>
                            <label class="form-check-label" for="autoresponse">
                                <strong>Auto-Responses</strong> - Manage automatic responses
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="feedback" id="feedback" {{ 'checked' if settings.get('feedback', True) }}>
                            <label class="form-check-label" for="feedback">
                                <strong>Feedback System</strong> - User feedback commands
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Entertainment Commands -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-gamepad me-2"></i>Entertainment Commands
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="8ball" id="8ball" {{ 'checked' if settings.get('8ball', True) }}>
                            <label class="form-check-label" for="8ball">
                                <strong>Magic 8-Ball</strong> - Ask the magic 8-ball questions
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="jokes" id="jokes" {{ 'checked' if settings.get('jokes', True) }}>
                            <label class="form-check-label" for="jokes">
                                <strong>Jokes & Humor</strong> - Random jokes and puns
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="laugh" id="laugh" {{ 'checked' if settings.get('laugh', True) }}>
                            <label class="form-check-label" for="laugh">
                                <strong>Laugh Reactions</strong> - Bot laugh responses
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="knockknock" id="knockknock" {{ 'checked' if settings.get('knockknock', True) }}>
                            <label class="form-check-label" for="knockknock">
                                <strong>Knock-Knock Jokes</strong> - Interactive knock-knock jokes
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="minesweeper" id="minesweeper" {{ 'checked' if settings.get('minesweeper', True) }}>
                            <label class="form-check-label" for="minesweeper">
                                <strong>Minesweeper Game</strong> - Interactive minesweeper
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="ascii" id="ascii" {{ 'checked' if settings.get('ascii', True) }}>
                            <label class="form-check-label" for="ascii">
                                <strong>ASCII Art</strong> - Generate ASCII art from text
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="roll" id="roll" {{ 'checked' if settings.get('roll', True) }}>
                            <label class="form-check-label" for="roll">
                                <strong>Dice Rolling</strong> - Roll dice with various configurations
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="games" id="games" {{ 'checked' if settings.get('games', True) }}>
                            <label class="form-check-label" for="games">
                                <strong>General Games</strong> - Other gaming commands
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utility Commands -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>Utility Commands
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="weather" id="weather" {{ 'checked' if settings.get('weather', True) }}>
                            <label class="form-check-label" for="weather">
                                <strong>Weather Information</strong> - Get weather for any location
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="convert" id="convert" {{ 'checked' if settings.get('convert', True) }}>
                            <label class="form-check-label" for="convert">
                                <strong>Unit Conversion</strong> - Convert between units
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="ping" id="ping" {{ 'checked' if settings.get('ping', True) }}>
                            <label class="form-check-label" for="ping">
                                <strong>Ping & Latency</strong> - Check bot response time
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="help" id="help" {{ 'checked' if settings.get('help', True) }}>
                            <label class="form-check-label" for="help">
                                <strong>Help Commands</strong> - Show command help and usage
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="say" id="say" {{ 'checked' if settings.get('say', True) }}>
                            <label class="form-check-label" for="say">
                                <strong>Say Command</strong> - Make the bot repeat text
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Information Commands -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Information Commands
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="crypto" id="crypto" {{ 'checked' if settings.get('crypto', True) }}>
                            <label class="form-check-label" for="crypto">
                                <strong>Cryptocurrency Prices</strong> - Get real-time crypto data
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="reddit" id="reddit" {{ 'checked' if settings.get('reddit', True) }}>
                            <label class="form-check-label" for="reddit">
                                <strong>Reddit Content</strong> - Browse Reddit posts
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="bible" id="bible" {{ 'checked' if settings.get('bible', True) }}>
                            <label class="form-check-label" for="bible">
                                <strong>Bible Verses</strong> - Look up Bible passages
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="dino" id="dino" {{ 'checked' if settings.get('dino', True) }}>
                            <label class="form-check-label" for="dino">
                                <strong>Dinosaur Facts</strong> - Learn about dinosaurs
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>System Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="command_cooldown" class="form-label">Command Cooldown (seconds)</label>
                            <input type="number" class="form-control" name="command_cooldown" id="command_cooldown"
                                   value="{{ settings.get('command_cooldown', 3) }}" min="0" max="60">
                            <div class="form-text">Cooldown between commands to prevent spam</div>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="welcome_messages" id="welcome_messages" {{ 'checked' if settings.get('welcome_messages', True) }}>
                            <label class="form-check-label" for="welcome_messages">
                                <strong>Welcome Messages</strong> - Send welcome messages to new members
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="spam_protection" id="spam_protection" {{ 'checked' if settings.get('spam_protection', True) }}>
                            <label class="form-check-label" for="spam_protection">
                                <strong>Spam Protection</strong> - Prevent command spam
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="embed_color" class="form-label">Embed Color</label>
                            <input type="color" class="form-control form-control-color" name="embed_color" id="embed_color"
                                   value="{{ settings.get('embed_color', '#4e73df') }}">
                            <div class="form-text">Default color for bot embeds</div>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="logging_enabled" id="logging_enabled" {{ 'checked' if settings.get('logging_enabled', True) }}>
                            <label class="form-check-label" for="logging_enabled">
                                <strong>Command Logging</strong> - Log command usage
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="auto_delete_commands" id="auto_delete_commands" {{ 'checked' if settings.get('auto_delete_commands', False) }}>
                            <label class="form-check-label" for="auto_delete_commands">
                                <strong>Auto-Delete Commands</strong> - Automatically delete command messages
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Buttons -->
        <div class="card">
            <div class="card-body">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-info me-md-2" onclick="testDatabase()">
                        <i class="fas fa-database me-2"></i>Test Database
                    </button>
                    <button type="button" class="btn btn-secondary me-md-2" onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i>Reset
                    </button>
                    <button type="button" class="btn btn-warning me-md-2" onclick="loadDefaults()">
                        <i class="fas fa-cog me-2"></i>Load Defaults
                    </button>
                    <button type="submit" class="btn btn-success" id="saveBtn">
                        <i class="fas fa-save me-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>

    </form>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

<script>
// Form submission handler
document.getElementById('guildSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings();
});

function saveSettings() {
    const form = document.getElementById('guildSettingsForm');
    const formData = new FormData(form);
    const settings = {};

    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input && input.type === 'checkbox') {
            settings[key] = input.checked;
        } else if (input && input.type === 'number') {
            settings[key] = parseInt(value);
        } else {
            settings[key] = value;
        }
    }

    // Handle unchecked checkboxes (they don't appear in FormData)
    form.querySelectorAll('input[type="checkbox"]').forEach(input => {
        if (!settings.hasOwnProperty(input.name)) {
            settings[input.name] = false;
        }
    });

    // Show loading state
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving to Database...';
    saveBtn.disabled = true;

    // Get guild ID
    const guildId = {{ guild.id if guild and guild.id else 'null' }};

    // Debug logging
    console.log('Guild ID:', guildId);
    console.log('Settings to save to database:', settings);

    if (!guildId || guildId === null) {
        showToast('Error: Guild ID not found. Please refresh the page and try again.', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        return;
    }

    // Save to database via API
    fetch('/api/settings/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            guild_id: guildId,
            settings: settings
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('✅ Settings saved to database! Changes apply immediately to Discord bot.', 'success');
            console.log('Database save successful:', data);
        } else {
            showToast('❌ Database Error: ' + (data.error || 'Failed to save settings'), 'error');
            console.error('Database save failed:', data);
        }
    })
    .catch(error => {
        console.error('Error saving to database:', error);
        showToast('❌ Failed to save settings to database: ' + error.message, 'error');
    })
    .finally(() => {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function testDatabase() {
    const testBtn = document.querySelector('button[onclick="testDatabase()"]');
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    testBtn.disabled = true;

    fetch('/api/test-database')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('✅ Database connection successful!', 'success');
            console.log('Database test result:', data);
        } else {
            showToast('❌ Database connection failed!', 'error');
            console.error('Database test failed:', data);
        }
    })
    .catch(error => {
        console.error('Database test error:', error);
        showToast('❌ Database test failed: ' + error.message, 'error');
    })
    .finally(() => {
        testBtn.innerHTML = originalText;
        testBtn.disabled = false;
    });
}

function resetForm() {
    if (confirm('Are you sure you want to reset all settings to their current saved values?')) {
        location.reload();
    }
}

function loadDefaults() {
    if (confirm('Are you sure you want to load default settings? This will enable all commands and reset configurations.')) {
        // Set all checkboxes to checked
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });

        // Reset other inputs to defaults
        document.querySelector('input[name="prefix"]').value = 'l.';
        document.querySelector('input[name="command_cooldown"]').value = '3';
        document.querySelector('input[name="embed_color"]').value = '#4e73df';

        // Uncheck auto_delete_commands (default false)
        document.querySelector('input[name="auto_delete_commands"]').checked = false;

        showToast('ℹ️ Default settings loaded. Click Save to apply changes.', 'info');
    }
}

function showToast(message, type = 'success') {
    // Create toast if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1050';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'info' ? 'info' : 'success'} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toastEl);

    // Show toast
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    // Remove from DOM after hiding
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

// Load current settings on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Guild settings page loaded for guild {{ guild.id if guild and guild.id else "UNKNOWN" }}');
    console.log('Current settings:', {{ settings | tojson | safe }});

    // Validate guild data
    const guildId = {{ guild.id if guild and guild.id else 'null' }};
    if (!guildId || guildId === null) {
        console.error('WARNING: Guild ID is missing!');
        showToast('⚠️ Warning: Guild data may not be loaded properly. Try refreshing the page.', 'error');
    }
});
</script>

{% endblock %}