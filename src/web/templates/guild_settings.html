{% extends "base.html" %}

{% block title %}{{ guild.name }} Settings - Ladbot Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <div>
                    <h3>
                        {% if guild.icon %}
                            <img src="{{ guild.icon }}" class="rounded-circle me-2" width="40" height="40">
                        {% else %}
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                <i class="fas fa-server text-white"></i>
                            </div>
                        {% endif %}
                        {{ guild.name }} Settings
                    </h3>
                    <p class="text-muted mb-0">Configure bot behavior for this server</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Form -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Server Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="guildSettingsForm">
                        <!-- Basic Settings -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-wrench"></i> Basic Settings
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Command Prefix</label>
                                            <input type="text" class="form-control" name="prefix"
                                                   value="{{ settings.prefix or 'l.' }}"
                                                   placeholder="l." maxlength="5">
                                            <small class="text-muted">The prefix used for bot commands</small>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="welcome_messages"
                                                   id="welcome_messages" {{ 'checked' if settings.welcome_messages else '' }}>
                                            <label class="form-check-label" for="welcome_messages">
                                                <strong>Welcome Messages</strong><br>
                                                <small class="text-muted">Send welcome messages to new members</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="autoresponses"
                                                   id="autoresponses" {{ 'checked' if settings.autoresponses else '' }}>
                                            <label class="form-check-label" for="autoresponses">
                                                <strong>Auto Responses</strong><br>
                                                <small class="text-muted">Enable automatic responses to messages</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-gamepad"></i> Command Categories
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="weather"
                                                   id="weather" {{ 'checked' if settings.weather else '' }}>
                                            <label class="form-check-label" for="weather">
                                                <strong>Weather Commands</strong><br>
                                                <small class="text-muted">Enable weather information commands</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="crypto"
                                                   id="crypto" {{ 'checked' if settings.crypto else '' }}>
                                            <label class="form-check-label" for="crypto">
                                                <strong>Crypto Commands</strong><br>
                                                <small class="text-muted">Enable cryptocurrency price commands</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="games"
                                                   id="games" {{ 'checked' if settings.games else '' }}>
                                            <label class="form-check-label" for="games">
                                                <strong>Game Commands</strong><br>
                                                <small class="text-muted">Enable interactive games and entertainment</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="reddit"
                                                   id="reddit" {{ 'checked' if settings.reddit else '' }}>
                                            <label class="form-check-label" for="reddit">
                                                <strong>Reddit Commands</strong><br>
                                                <small class="text-muted">Enable Reddit browsing commands</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Utility Commands -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-tools"></i> Utility Commands
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="help"
                                                   id="help" {{ 'checked' if settings.help else '' }}>
                                            <label class="form-check-label" for="help">
                                                <strong>Help Commands</strong><br>
                                                <small class="text-muted">Enable help and command information</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="ping"
                                                   id="ping" {{ 'checked' if settings.ping else '' }}>
                                            <label class="form-check-label" for="ping">
                                                <strong>Ping Commands</strong><br>
                                                <small class="text-muted">Enable bot latency testing</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="info"
                                                   id="info" {{ 'checked' if settings.info else '' }}>
                                            <label class="form-check-label" for="info">
                                                <strong>Info Commands</strong><br>
                                                <small class="text-muted">Enable bot and server information</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="tools"
                                                   id="tools" {{ 'checked' if settings.tools else '' }}>
                                            <label class="form-check-label" for="tools">
                                                <strong>Tool Commands</strong><br>
                                                <small class="text-muted">Enable utility tools and converters</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-laugh"></i> Entertainment Commands
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="jokes"
                                                   id="jokes" {{ 'checked' if settings.jokes else '' }}>
                                            <label class="form-check-label" for="jokes">
                                                <strong>Joke Commands</strong><br>
                                                <small class="text-muted">Enable random jokes and humor</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="eightball"
                                                   id="eightball" {{ 'checked' if settings.eightball else '' }}>
                                            <label class="form-check-label" for="eightball">
                                                <strong>8Ball Commands</strong><br>
                                                <small class="text-muted">Enable magic 8-ball predictions</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="roll"
                                                   id="roll" {{ 'checked' if settings.roll else '' }}>
                                            <label class="form-check-label" for="roll">
                                                <strong>Dice Roll Commands</strong><br>
                                                <small class="text-muted">Enable dice rolling and random generators</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="ascii_art"
                                                   id="ascii_art" {{ 'checked' if settings.ascii_art else '' }}>
                                            <label class="form-check-label" for="ascii_art">
                                                <strong>ASCII Art</strong><br>
                                                <small class="text-muted">Enable text-to-ASCII art generation</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Information Commands -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-info-circle"></i> Information Commands
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="bible"
                                                   id="bible" {{ 'checked' if settings.bible else '' }}>
                                            <label class="form-check-label" for="bible">
                                                <strong>Bible Verses</strong><br>
                                                <small class="text-muted">Enable Bible verse lookup commands</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="dinosaurs"
                                                   id="dinosaurs" {{ 'checked' if settings.dinosaurs else '' }}>
                                            <label class="form-check-label" for="dinosaurs">
                                                <strong>Dinosaur Facts</strong><br>
                                                <small class="text-muted">Enable dinosaur information commands</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="feedback"
                                                   id="feedback" {{ 'checked' if settings.feedback else '' }}>
                                            <label class="form-check-label" for="feedback">
                                                <strong>Feedback Commands</strong><br>
                                                <small class="text-muted">Enable user feedback submission</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt"></i> Moderation Settings
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="moderation_enabled"
                                                   id="moderation_enabled" {{ 'checked' if settings.moderation_enabled else '' }}>
                                            <label class="form-check-label" for="moderation_enabled">
                                                <strong>Moderation Tools</strong><br>
                                                <small class="text-muted">Enable moderation commands for admins</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="spam_protection"
                                                   id="spam_protection" {{ 'checked' if settings.spam_protection else '' }}>
                                            <label class="form-check-label" for="spam_protection">
                                                <strong>Spam Protection</strong><br>
                                                <small class="text-muted">Enable spam detection and prevention</small>
                                            </label>
                                        </div>

                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" name="auto_delete_commands"
                                                   id="auto_delete_commands" {{ 'checked' if settings.auto_delete_commands else '' }}>
                                            <label class="form-check-label" for="auto_delete_commands">
                                                <strong>Auto-Delete Commands</strong><br>
                                                <small class="text-muted">Automatically delete command messages</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cog"></i> Advanced Settings
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">Command Cooldown (seconds)</label>
                                                    <input type="number" class="form-control" name="command_cooldown"
                                                           value="{{ settings.command_cooldown or 3 }}"
                                                           min="0" max="60">
                                                    <small class="text-muted">Cooldown between command uses per user</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label">Embed Color</label>
                                                    <input type="color" class="form-control form-control-color" name="embed_color"
                                                           value="{{ settings.embed_color or '#4e73df' }}">
                                                    <small class="text-muted">Default color for bot embeds</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check mt-4">
                                                    <input class="form-check-input" type="checkbox" name="logging_enabled"
                                                           id="logging_enabled" {{ 'checked' if settings.logging_enabled else '' }}>
                                                    <label class="form-check-label" for="logging_enabled">
                                                        <strong>Enable Logging</strong><br>
                                                        <small class="text-muted">Log command usage and events</small>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg" id="saveBtn">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset to Defaults
                                    </button>
                                    <button type="button" class="btn btn-info btn-lg" onclick="loadDefaults()">
                                        <i class="fas fa-refresh"></i> Load Defaults
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Info Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-server"></i> Server Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Server Name:</strong><br>
                            <span class="text-muted">{{ guild.name }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Member Count:</strong><br>
                            <span class="text-muted">{{ guild.member_count or 'Unknown' }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Server ID:</strong><br>
                            <span class="text-muted font-monospace">{{ guild.id }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Owner:</strong><br>
                            <span class="text-muted">{{ 'You' if guild.is_owner else 'Server Owner' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="saveToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-cogs me-2"></i>
            <strong class="me-auto">Settings</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Settings saved successfully!
        </div>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('guildSettingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveSettings();
});

function saveSettings() {
    const form = document.getElementById('guildSettingsForm');
    const formData = new FormData(form);
    const settings = {};

    // Convert form data to object
    for (let [key, value] of formData.entries()) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input && input.type === 'checkbox') {
            settings[key] = input.checked;
        } else if (input && input.type === 'number') {
            settings[key] = parseInt(value);
        } else {
            settings[key] = value;
        }
    }

    // Handle unchecked checkboxes (they don't appear in FormData)
    form.querySelectorAll('input[type="checkbox"]').forEach(input => {
        if (!settings.hasOwnProperty(input.name)) {
            settings[input.name] = false;
        }
    });

    // Show loading state
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;

    // Save to server - FIXED API CALL
    fetch('/api/settings/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            guild_id: {{ guild.id }},
            settings: settings
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Settings saved successfully! Changes will take effect immediately.', 'success');
            console.log('Settings saved:', data);
        } else {
            showToast('Error: ' + (data.error || 'Failed to save settings'), 'error');
            console.error('Save failed:', data);
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        showToast('Failed to save settings. Please check your connection and try again.', 'error');
    })
    .finally(() => {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

function resetForm() {
    if (confirm('Are you sure you want to reset all settings to their current saved values?')) {
        location.reload();
    }
}

function loadDefaults() {
    if (confirm('Are you sure you want to load default settings? This will enable all commands and reset configurations.')) {
        // Set all checkboxes to checked
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });

        // Reset text inputs to defaults
        document.querySelector('input[name="prefix"]').value = 'l.';
        document.querySelector('input[name="command_cooldown"]').value = '3';
        document.querySelector('input[name="embed_color"]').value = '#4e73df';

        showToast('Default settings loaded. Click Save to apply changes.', 'info');
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('saveToast');
    const toastBody = toast.querySelector('.toast-body');
    const toastHeader = toast.querySelector('.toast-header');

    toastBody.textContent = message;

    // Change color and icon based on type
    if (type === 'error') {
        toast.className = 'toast bg-danger text-white';
        toastHeader.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
    } else if (type === 'info') {
        toast.className = 'toast bg-info text-white';
        toastHeader.querySelector('i').className = 'fas fa-info-circle me-2';
    } else {
        toast.className = 'toast bg-success text-white';
        toastHeader.querySelector('i').className = 'fas fa-check-circle me-2';
    }

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Load current settings on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Guild settings page loaded for guild {{ guild.id }}');
    console.log('Current settings:', {{ settings | tojson }});
});

// Auto-save draft every 30 seconds (optional feature)
let autoSaveTimer;
document.querySelectorAll('input, select').forEach(input => {
    input.addEventListener('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            console.log('Auto-draft saved locally');
            // Could implement localStorage draft saving here
        }, 30000);
    });
});
</script>

<style>
.form-check-label strong {
    color: #495057;
}

.card-header h6 {
    color: #5a5c69;
}

.form-control:focus, .form-check-input:focus {
    border-color: #4e73df;
    box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
}

.btn-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.btn-primary:hover {
    background-color: #2e59d9;
    border-color: #2653d4;
}

.toast {
    min-width: 300px;
}

.font-monospace {
    font-family: 'Courier New', Courier, monospace;
}
</style>
{% endblock %}