{% extends "base.html" %}

{% block title %}Analytics - Ladbot Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> Bot Analytics</h1>
            <p class="text-muted">Detailed performance and usage statistics</p>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Total Servers</h5>
                            <h2>{{ analytics.total_guilds or 0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-server fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Total Users</h5>
                            <h2>{{ analytics.total_users or 0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Bot Latency</h5>
                            <h2>{{ analytics.bot_latency or 0 }}ms</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-wifi fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Uptime</h5>
                            <h2 style="font-size: 1.5rem;">{{ analytics.uptime or '0s' }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Total Commands</h5>
                            <h2>{{ analytics.total_commands or 0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-terminal fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Loaded Cogs</h5>
                            <h2>{{ analytics.loaded_cogs or 0 }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-puzzle-piece fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Usage and Guild Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-terminal"></i> Command Usage Statistics</h5>
                </div>
                <div class="card-body">
                    {% if analytics.command_stats %}
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Command</th>
                                        <th>Usage Count</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for command, count in analytics.command_stats.items() %}
                                    <tr>
                                        <td><code>{{ command }}</code></td>
                                        <td><span class="badge bg-primary">{{ count }}</span></td>
                                        <td>
                                            {% if count > 0 %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Unused</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>No command usage data available</p>
                            <small>Commands will appear here after they are used</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Guild Information -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-server"></i> Server Details</h5>
                </div>
                <div class="card-body">
                    {% if analytics.guild_data %}
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-sm table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Server Name</th>
                                        <th>Members</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for guild in analytics.guild_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ guild.name }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ guild.id }}</small>
                                        </td>
                                        <td><span class="badge bg-info">{{ guild.member_count }}</span></td>
                                        <td><span class="badge bg-success">Active</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-server fa-3x mb-3"></i>
                            <p>No server data available</p>
                            <small>Bot is not connected to any servers</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tachometer-alt"></i> Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">{{ analytics.bot_latency or 0 }}ms</h3>
                                <p class="text-muted">Average Latency</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-success" style="width: {{ (100 - (analytics.bot_latency or 0) / 2) if (analytics.bot_latency or 0) < 200 else 25 }}%"></div>
                                </div>
                                <small class="text-muted">
                                    {% if (analytics.bot_latency or 0) < 100 %}
                                        Excellent
                                    {% elif (analytics.bot_latency or 0) < 200 %}
                                        Good
                                    {% else %}
                                        Fair
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-info">{{ analytics.uptime or '0s' }}</h3>
                                <p class="text-muted">Current Uptime</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-info" style="width: 95%"></div>
                                </div>
                                <small class="text-muted">Running smoothly</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-primary">{{ analytics.loaded_cogs or 0 }}/{{ analytics.total_commands or 0 }}</h3>
                                <p class="text-muted">Cogs/Commands Loaded</p>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-primary" style="width: {{ (analytics.loaded_cogs / analytics.total_commands * 100) if analytics.total_commands else 0 }}%"></div>
                                </div>
                                <small class="text-muted">System health</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> System Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                                <h6>Bot Status</h6>
                                <span class="badge bg-success fs-6">Online</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-link text-success fa-2x mb-2"></i>
                                <h6>Discord API</h6>
                                <span class="text-success">Connected</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-globe text-primary fa-2x mb-2"></i>
                                <h6>Web Dashboard</h6>
                                <span class="text-success">Active</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-clock text-info fa-2x mb-2"></i>
                                <h6>Last Updated</h6>
                                <span class="text-muted" id="last-updated">Just now</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Analytics Charts (Placeholder for future features) -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Usage Trends</h5>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Usage trend charts coming soon</p>
                        <small>Historical command usage and performance metrics</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> User Activity</h5>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-user-chart fa-3x mb-3"></i>
                        <p>User activity analytics coming soon</p>
                        <small>Active users, peak hours, and engagement metrics</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export and Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Export & Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Data Export</h6>
                            <p class="text-muted">Export analytics data for external analysis</p>
                            <button class="btn btn-outline-primary me-2" onclick="exportData('json')">
                                <i class="fas fa-file-code"></i> Export JSON
                            </button>
                            <button class="btn btn-outline-success" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Quick Actions</h6>
                            <p class="text-muted">Manage bot performance and monitoring</p>
                            <button class="btn btn-outline-info me-2" onclick="clearStats()">
                                <i class="fas fa-trash"></i> Clear Stats
                            </button>
                            <button class="btn btn-outline-warning" onclick="resetCounters()">
                                <i class="fas fa-redo"></i> Reset Counters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-primary me-2">
                <i class="fas fa-cog"></i> Manage Settings
            </a>
            <button onclick="location.reload()" class="btn btn-info me-2">
                <i class="fas fa-sync"></i> Refresh Data
            </button>
            <button onclick="toggleAutoRefresh()" class="btn btn-outline-secondary" id="auto-refresh-btn">
                <i class="fas fa-play"></i> Auto Refresh
            </button>
        </div>
    </div>
</div>

<script>
let autoRefreshInterval = null;
let autoRefreshEnabled = false;

// Update timestamp
function updateTimestamp() {
    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
}

// Toggle auto-refresh
function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');

    if (autoRefreshEnabled) {
        // Disable auto-refresh
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Auto Refresh';
        btn.className = 'btn btn-outline-secondary';
    } else {
        // Enable auto-refresh
        autoRefreshInterval = setInterval(function() {
            updateTimestamp();
            // You can add more refresh logic here
        }, 30000); // 30 seconds

        autoRefreshEnabled = true;
        btn.innerHTML = '<i class="fas fa-pause"></i> Stop Auto Refresh';
        btn.className = 'btn btn-outline-danger';
    }
}

// Export data functions
function exportData(format) {
    const data = {
        timestamp: new Date().toISOString(),
        stats: {
            guilds: {{ analytics.total_guilds or 0 }},
            users: {{ analytics.total_users or 0 }},
            commands: {{ analytics.total_commands or 0 }},
            latency: {{ analytics.bot_latency or 0 }},
            uptime: '{{ analytics.uptime or "0s" }}',
            loaded_cogs: {{ analytics.loaded_cogs or 0 }}
        },
        command_stats: {{ analytics.command_stats | tojson if analytics.command_stats else '{}' }},
        guild_data: {{ analytics.guild_data | tojson if analytics.guild_data else '[]' }}
    };

    if (format === 'json') {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        downloadFile(blob, 'ladbot-analytics.json');
    } else if (format === 'csv') {
        // Convert to CSV format
        let csv = 'Metric,Value\n';
        csv += `Guilds,${data.stats.guilds}\n`;
        csv += `Users,${data.stats.users}\n`;
        csv += `Commands,${data.stats.commands}\n`;
        csv += `Latency,${data.stats.latency}ms\n`;
        csv += `Uptime,${data.stats.uptime}\n`;
        csv += `Loaded Cogs,${data.stats.loaded_cogs}\n`;

        const blob = new Blob([csv], { type: 'text/csv' });
        downloadFile(blob, 'ladbot-analytics.csv');
    }
}

function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Clear stats function
function clearStats() {
    if (confirm('Are you sure you want to clear all statistics? This action cannot be undone.')) {
        // This would need to be implemented on the backend
        alert('Clear stats functionality would be implemented here');
    }
}

// Reset counters function
function resetCounters() {
    if (confirm('Are you sure you want to reset usage counters?')) {
        // This would need to be implemented on the backend
        alert('Reset counters functionality would be implemented here');
    }
}

// Initial timestamp
updateTimestamp();

// Update timestamp every minute
setInterval(updateTimestamp, 60000);
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Usage Trends Chart
{% if analytics.usage_trends %}
const ctx = document.getElementById('usageTrendsChart').getContext('2d');
const usageData = {{ analytics.usage_trends | tojson }};

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: usageData.map(d => d.hour),
        datasets: [{
            label: 'Commands Used',
            data: usageData.map(d => d.usage),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}