{% extends "base.html" %}

{% block title %}Settings - Ladbot Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-cog"></i> Bot Settings</h1>
            <p class="text-muted">Manage bot configuration for your servers</p>
        </div>
    </div>

    <div class="row">
        <!-- Server List -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-server"></i> Select Server</h5>
                </div>
                <div class="card-body">
                    {% if guilds %}
                        <div class="list-group">
                            {% for guild in guilds %}
                            <a href="#" class="list-group-item list-group-item-action guild-item"
                               data-guild-id="{{ guild.id }}" data-guild-name="{{ guild.name }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ guild.name }}</h6>
                                    <small>{{ guild.member_count }} members</small>
                                </div>
                                <small class="text-muted">ID: {{ guild.id }}</small>
                            </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-server fa-3x mb-3"></i>
                            <p>No servers found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 id="settings-title"><i class="fas fa-cog"></i> Select a Server</h5>
                </div>
                <div class="card-body">
                    <div id="no-selection" class="text-center text-muted py-5">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <h5>Select a server from the left to manage its settings</h5>
                    </div>

                    <div id="loading" class="text-center" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Loading settings...</p>
                    </div>

                    <div id="settings-form" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-terminal"></i> Command Settings</h6>
                                <div id="command-settings">
                                    <!-- Command toggles will be populated here -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-puzzle-piece"></i> Feature Settings</h6>
                                <div id="feature-settings">
                                    <!-- Feature toggles will be populated here -->
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-success" id="save-settings">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                                <button type="button" class="btn btn-secondary" id="reset-settings">
                                    <i class="fas fa-undo"></i> Reset to Defaults
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Dashboard -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
let currentGuildId = null;
let currentSettings = {};

// Available settings configuration
const settingsConfig = {
    // Command settings
    'ping': { name: 'Ping Command', type: 'command', description: 'Basic ping/pong command' },
    'help': { name: 'Help Command', type: 'command', description: 'Command help system' },
    'feedback': { name: 'Feedback Command', type: 'command', description: 'User feedback system' },
    'say': { name: 'Say Command', type: 'command', description: 'Make bot repeat text' },
    'ascii': { name: 'ASCII Art', type: 'command', description: 'Generate ASCII art' },
    'cmd_8ball': { name: '8-Ball Command', type: 'command', description: 'Magic 8-ball responses' },
    'jokes': { name: 'Jokes Command', type: 'command', description: 'Random jokes' },
    'roll': { name: 'Dice Roll', type: 'command', description: 'Roll dice' },

    // Feature settings
    'weather': { name: 'Weather Commands', type: 'feature', description: 'Weather information' },
    'crypto': { name: 'Crypto Commands', type: 'feature', description: 'Cryptocurrency data' },
    'reddit': { name: 'Reddit Commands', type: 'feature', description: 'Reddit integration' },
    'bible': { name: 'Bible Commands', type: 'feature', description: 'Bible verses' },
    'minesweeper': { name: 'Minesweeper Game', type: 'feature', description: 'Minesweeper game' },
    'autoresponses': { name: 'Auto Responses', type: 'feature', description: 'Automatic message responses' },
    'games': { name: 'Games', type: 'feature', description: 'Various mini-games' }
};

// Guild selection
document.querySelectorAll('.guild-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();

        // Remove active class from all items
        document.querySelectorAll('.guild-item').forEach(i => i.classList.remove('active'));

        // Add active class to clicked item
        this.classList.add('active');

        const guildId = this.dataset.guildId;
        const guildName = this.dataset.guildName;

        loadGuildSettings(guildId, guildName);
    });
});

function loadGuildSettings(guildId, guildName) {
    currentGuildId = guildId;

    // Update title
    document.getElementById('settings-title').innerHTML = `<i class="fas fa-cog"></i> Settings for ${guildName}`;

    // Show loading
    document.getElementById('no-selection').style.display = 'none';
    document.getElementById('settings-form').style.display = 'none';
    document.getElementById('loading').style.display = 'block';

    // Fetch settings
    fetch(`/api/guild/${guildId}/settings`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            currentSettings = data.settings || {};
            renderSettings();

            // Hide loading, show form
            document.getElementById('loading').style.display = 'none';
            document.getElementById('settings-form').style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading settings:', error);
            document.getElementById('loading').innerHTML = '<div class="alert alert-danger">Failed to load settings</div>';
        });
}

function renderSettings() {
    const commandSettings = document.getElementById('command-settings');
    const featureSettings = document.getElementById('feature-settings');

    commandSettings.innerHTML = '';
    featureSettings.innerHTML = '';

    Object.keys(settingsConfig).forEach(settingKey => {
        const config = settingsConfig[settingKey];
        const isEnabled = currentSettings[settingKey] !== false; // Default to true if not set

        const toggleHtml = `
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="${settingKey}" ${isEnabled ? 'checked' : ''}>
                <label class="form-check-label" for="${settingKey}">
                    <strong>${config.name}</strong>
                    <br>
                    <small class="text-muted">${config.description}</small>
                </label>
            </div>
        `;

        if (config.type === 'command') {
            commandSettings.innerHTML += toggleHtml;
        } else {
            featureSettings.innerHTML += toggleHtml;
        }
    });
}

// Save settings
document.getElementById('save-settings').addEventListener('click', function() {
    if (!currentGuildId) return;

    const newSettings = {};

    Object.keys(settingsConfig).forEach(settingKey => {
        const checkbox = document.getElementById(settingKey);
        newSettings[settingKey] = checkbox.checked;
    });

    // Show loading state
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    this.disabled = true;

    fetch(`/api/guild/${currentGuildId}/settings`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(newSettings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> Settings saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('settings-form').prepend(alert);

            currentSettings = newSettings;
        } else {
            throw new Error(data.error || 'Failed to save settings');
        }
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> Failed to save settings: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('settings-form').prepend(alert);
    })
    .finally(() => {
        // Reset button
        this.innerHTML = '<i class="fas fa-save"></i> Save Settings';
        this.disabled = false;
    });
});

// Reset settings
document.getElementById('reset-settings').addEventListener('click', function() {
    if (!currentGuildId) return;

    if (confirm('Are you sure you want to reset all settings to defaults?')) {
        // Reset all checkboxes to checked (default enabled)
        Object.keys(settingsConfig).forEach(settingKey => {
            const checkbox = document.getElementById(settingKey);
            checkbox.checked = true;
        });
    }
});
</script>
{% endblock %}